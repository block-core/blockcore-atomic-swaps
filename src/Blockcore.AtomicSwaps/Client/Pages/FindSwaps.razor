@page "/findswaps"

@using Blockcore.AtomicSwaps.Server.Controllers
@using NBitcoin
@using Blockcore.AtomicSwaps.BlockcoreWallet
@inject HttpClient Http
@inject Storage storage;
@inject SwapsConfiguration SwapsConfiguration;
@inject NavigationManager NavigationManager;
@inject ILogger<Index> Logger;
@inject IBlockcoreWalletConnector WalletConnector

<PageTitle>Find Atomic Swaps</PageTitle>


<MudText Typo="Typo.h3">Find Atomic Swaps</MudText>
<MudText Class="mb-8">This component helps find available swaps.</MudText>

<MudButton Color="Color.Info" Variant="Variant.Filled" @onclick="Fetch">Fetch Swaps</MudButton>

@if (!string.IsNullOrEmpty(error))
{
	<MudAlert Class="mt-3 mb-3" Severity="Severity.Error">@error</MudAlert>
}

@if (swaps != null)
{


	<MudTable Items="@swaps" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
		<HeaderContent>
			<MudTh>Swap Id</MudTh>
			<MudTh>Seller</MudTh>
			<MudTh>Buyer</MudTh>
			<MudTh>Date</MudTh>
			<MudTh>Is Mine</MudTh>
			<MudTh>Status</MudTh>
			<MudTh></MudTh>
		</HeaderContent>
		<RowTemplate>
			<MudTd DataLabel="Swap Id">@context.SwapSessionId</MudTd>
			<MudTd DataLabel="Seller">@Money.Satoshis(context.CoinSeller.Amount) - @context.CoinSeller.CoinSymbol</MudTd>
			<MudTd DataLabel="Buyer">@Money.Satoshis(context.CoinBuyer.Amount) - @context.CoinBuyer.CoinSymbol</MudTd>
			<MudTd DataLabel="Date">@context.Created </MudTd>
			<MudTd DataLabel="Is Mine">@(_walletAccounts.HasAccountKey(context.CoinSeller.SenderPubkey) ? "I am seller" : _walletAccounts.HasAccountKey(context.CoinBuyer.SenderPubkey) ? "I am buyer" : "not my swap")</MudTd>
				<MudTd DataLabel="Status">@context.Status </MudTd>
				<MudTd DataLabel="Details">
					<MudButton Color="Color.Info" Variant="Variant.Filled" @onclick="() => this.ViewSwap(context.SwapSessionId)">Details</MudButton>
				</MudTd>
			</RowTemplate>
		</MudTable>


}

@code {
	private IEnumerable<SwapSession> swaps = new List<SwapSession>();
	private bool _loading;

	Networks.Network network;
	List<string> NetworkList;

	string error;

	string SwapFrom = "STRAX";
	string SwapTo = "CITY";

	long amountToSell = 1;
	long amountToBuy = 10;
	private bool hasWallet;
	WalletAccounts? _walletAccounts;

	private async Task Fetch()
	{
		try
		{
			this.swaps = await Http.GetFromJsonAsync<List<SwapSession>>("api/SwapCoordinator");
		}
		catch (Exception ex)
		{

		}

	}

	protected override async Task OnInitializedAsync()
	{
		NetworkList = SwapsConfiguration.Networks.Keys.ToList();

		if (await WalletConnector.HasBlockcoreWallet() == false)
		{
			hasWallet = false;
			return;
		}

		hasWallet = true;

		_walletAccounts = storage.GetOrCreate<WalletAccounts>();

		await this.Fetch();
	}

	protected async Task ViewSwap(string session)
	{
		NavigationManager.NavigateTo($"viewswap/{session}");
	}

}
